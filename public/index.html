<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Styless C√° Nh√¢n</title>
    <link rel="stylesheet" href="style.css">
    <!-- Vue.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- Axios CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.9.0/axios.min.js" integrity="sha512-FPlUpimug7gt7Hn7swE8N2pHw/+oQMq/+R/hH/2hZ43VOQ+Kjh25rQzuLyPz7aUWKlRpI7wXbY6+U3oFPGjPOA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Left Panel - Tabs -->
            <div class="left-panel">
                <div class="tab-buttons">
                    <button 
                        class="tab-button" 
                        :class="{ active: leftTab === 'info' }" 
                        @click="leftTab = 'info'"
                    >C√° nh√¢n</button>
                    <button 
                        class="tab-button" 
                        :class="{ active: leftTab === 'ao' }" 
                        @click="leftTab = 'ao'"
                    >√Åo</button>
                    <button 
                        class="tab-button" 
                        :class="{ active: leftTab === 'quan' }" 
                        @click="leftTab = 'quan'"
                    >Qu·∫ßn</button>
                    <button 
                        class="tab-button" 
                        :class="{ active: leftTab === 'giay' }" 
                        @click="leftTab = 'giay'"
                    >Gi√†y</button>
                    <button 
                        class="tab-button" 
                        :class="{ active: leftTab === 'phu_kien' }" 
                        @click="leftTab = 'phu_kien'"
                    >Ph·ª• ki·ªán</button>
                </div>
                <div class="tab-content">
                    <div class="tab-pane" :class="{active: leftTab === 'info'}" v-show="leftTab === 'info'">
                        <div class="form-group">
                            <label>Chi·ªÅu cao (cm):</label>
                            <input type="number" v-model="paramHistories.height" min="100" max="250" placeholder="Nh·∫≠p chi·ªÅu cao" />
                        </div>
                        <div class="form-group">
                            <label>C√¢n n·∫∑ng (kg):</label>
                            <input type="number" v-model="paramHistories.weight" min="30" max="200" placeholder="Nh·∫≠p c√¢n n·∫∑ng" />
                        </div>
                        <div class="form-group">
                            <label>Gi·ªõi t√≠nh:</label>
                            <label><input type="radio" value="nam" v-model="paramHistories.gender" /> Nam</label>
                            <label><input type="radio" value="n·ªØ" v-model="paramHistories.gender" /> N·ªØ</label>
                        </div>
                        <div class="form-group">
                            <label>M√πa hi·ªán t·∫°i:</label>
                            <select v-model="paramHistories.season">
                                <option disabled value="">Ch·ªçn m√πa</option>
                                <option value="xu√¢n">Xu√¢n</option>
                                <option value="h·∫°">H·∫°</option>
                                <option value="thu">Thu</option>
                                <option value="ƒë√¥ng">ƒê√¥ng</option>
                            </select>
                        </div>
                    </div>
                    <div class="tab-pane" :class="{active: leftTab === 'ao'}" v-show="leftTab === 'ao'">
                        <div class="form-group">
                            <label>√Åo:</label>
                            <div class="ingredient-list">
                                <span 
                                    v-for="item in aoList" 
                                    class="ingredient-tag" 
                                    :class="{ selected: isSelected(item, 'ao') }"
                                    @click="toggleItem(item, 'ao')"
                                >
                                    {{ item }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" :class="{active: leftTab === 'quan'}" v-show="leftTab === 'quan'">
                        <div class="form-group">
                            <label>Qu·∫ßn:</label>
                            <div class="ingredient-list">
                                <span 
                                    v-for="item in quanList" 
                                    class="ingredient-tag" 
                                    :class="{ selected: isSelected(item, 'quan') }"
                                    @click="toggleItem(item, 'quan')"
                                >
                                    {{ item }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" :class="{active: leftTab === 'giay'}" v-show="leftTab === 'giay'">
                        <div class="form-group">
                            <label>Gi√†y:</label>
                            <div class="ingredient-list">
                                <span 
                                    v-for="item in giayList" 
                                    class="ingredient-tag" 
                                    :class="{ selected: isSelected(item, 'giay') }"
                                    @click="toggleItem(item, 'giay')"
                                >
                                    {{ item }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" :class="{active: leftTab === 'phu_kien'}" v-show="leftTab === 'phu_kien'">
                        <div class="form-group">
                            <label>Ph·ª• ki·ªán:</label>
                            <div class="ingredient-list">
                                <span 
                                    v-for="item in phuKienList" 
                                    class="ingredient-tag" 
                                    :class="{ selected: isSelected(item, 'phu_kien') }"
                                    @click="toggleItem(item, 'phu_kien')"
                                >
                                    {{ item }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Panel - Chat -->
            <div class="center-panel">
                <div class="chat-header">
                    <h1><span style="font-size: 32px;">üëó Styless AI</span></h1>
                    <p>G·ª£i √Ω set ƒë·ªì d·ª±a tr√™n th√¥ng tin c√° nh√¢n v√† s·ªü th√≠ch c·ªßa b·∫°n</p>
                </div>
                
                <!-- Selected Items Display -->
                <div class="selected-items">
                    <h3>Mong mu·ªën c·ªßa b·∫°n:</h3>
                    <ul class="user-info-list user-info-row">
                        <li><b>Chi·ªÅu cao:</b> {{ paramHistories && paramHistories.height ? paramHistories.height + ' cm' : 'Ch∆∞a nh·∫≠p' }}</li>
                        <li><b>C√¢n n·∫∑ng:</b> {{ paramHistories && paramHistories.weight ? paramHistories.weight + ' kg' : 'Ch∆∞a nh·∫≠p' }}</li>
                        <li><b>Gi·ªõi t√≠nh:</b> {{ paramHistories && paramHistories.gender ? paramHistories.gender : 'Ch∆∞a ch·ªçn' }}</li>
                        <li><b>M√πa hi·ªán t·∫°i:</b> {{ paramHistories && paramHistories.season ? paramHistories.season : 'Ch∆∞a ch·ªçn' }}</li>
                    </ul>
                    <h3>L·ª±a ch·ªçn c·ªßa b·∫°n:</h3>
                    <div class="selected-tags">
                        <div v-if="allSelectedItems.length === 0" class="empty-selection">
                            Ch∆∞a ch·ªçn nguy√™n li·ªáu n√†o, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ch·ªçn gi√∫p b·∫°n !
                        </div>
                        <template v-else>
                            <div v-for="item in allSelectedItems" class="selected-tag">
                                {{ item }}
                                <span class="remove" @click="removeSelectedItem(item)">√ó</span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="chat-messages">
                    <div v-if="messages.length === 0" class="welcome-message">
                        <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi AI Styless!</h3>
                        <p>M·ªôt v√†i b·ªô ƒë·ªì b·∫°n y√™u th√≠ch nh·∫•t</p>
                    </div>
                    <div v-else>
                        <div v-for="message in messages" :class="['message', message.type]">
                            <div class="message-content">
                                <template v-if="Array.isArray(message.content)">
                                    <div class="outfit-list">
                                        <div v-for="(set, idx) in message.content" :key="idx" class="outfit-item">
                                            <div class="outfit-title">{{ set.name }}</div>
                                            <div class="outfit-desc">{{ set.description }}</div>
                                            <ul class="outfit-detail">
                                                <li><b>√Åo:</b> <span>{{ set.ao.map(a => getNameById('ao', a.id)).join(', ') }}</span></li>
                                                <li><b>Qu·∫ßn:</b> <span>{{ set.quan.map(q => getNameById('quan', q.id)).join(', ') }}</span></li>
                                                <li><b>Gi√†y:</b> <span>{{ set.giay.map(g => getNameById('giay', g.id)).join(', ') }}</span></li>
                                                <li><b>Ph·ª• ki·ªán:</b> <span>{{ set.phu_kien.map(p => getNameById('phu_kien', p.id)).join(', ') }}</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </template>
                                <!-- N·∫øu message.content l√† object nh∆∞ { ao: [...], quan: [...], ... } -->
                                <template v-else>
                                    <div v-if="typeof message.content === 'object'">
                                        <div><b>√Åo:</b> {{ (message.content.ao || []).join(', ') }}</div>
                                        <div><b>Qu·∫ßn:</b> {{ (message.content.quan || []).join(', ') }}</div>
                                        <div><b>Gi√†y:</b> {{ (message.content.giay || []).join(', ') }}</div>
                                        <div><b>Ph·ª• ki·ªán:</b> {{ (message.content.phu_kien || []).join(', ') }}</div>
                                    </div>
                                    <div v-else>
                                        {{ message.content }}
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            placeholder="B·∫°n mu·ªën n·∫•u m√≥n g√¨ h√¥m nay?"
                            rows="1"
                            v-model="userMessage"
                            @input="resizeTextarea"
                            @keypress.enter.prevent="sendMessage"
                        ></textarea>
                        <button class="send-button" @click="sendMessage" :disabled="isSending">
                            {{ isSending ? 'ƒêang g·ª≠i...' : 'G·ª≠i' }}
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - History -->
            <div class="right-panel">
                <div class="history-header">
                    <h2>üìö L·ªãch s·ª≠</h2>
                    <p>C√°c Outfit ƒë√£ g·ª£i √Ω</p>
                </div>  
                
                <div class="history-list">
                    <div v-for="item in history" class="history-item" @click="openHistoryPopup(item)">
                        <div class="history-title">{{ item.results[0]?.name }}</div>
                        <div class="history-time">{{ item.time }}</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Popup for History Details -->
        <div class="popup-overlay" v-if="showPopup" @click.self="closePopup">
            <div class="popup-content">
                <button class="popup-close" @click="closePopup">√ó</button>
                <div v-if="selectedHistoryItem">
                    <h2 class="popup-title">{{ selectedHistoryItem.results[0]?.name }}</h2>
                    <div class="popup-section" v-for="result in selectedHistoryItem.results">
                        <div><b>M√¥ t·∫£:</b> {{ result.description }}</div>
                        <div><b>√Åo:</b> {{ getNamesByIds(aoListRaw, result.ao) }}</div>
                        <div><b>Qu·∫ßn:</b> {{ getNamesByIds(quanListRaw, result.quan) }}</div>
                        <div><b>Gi√†y:</b> {{ getNamesByIds(giayListRaw, result.giay) }}</div>
                        <div><b>Ph·ª• ki·ªán:</b> {{ getNamesByIds(phuKienListRaw, result.phu_kien) }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                userMessage: '',
                isSending: false,
                messages: [],
                countAsk: 1,
                lastAsk: undefined,
                history: [],
                showPopup: false,
                selectedHistoryItem: null,
                aoList: [],
                quanList: [],
                giayList: [],
                phuKienList: [],
                selectedItems: {
                    ao: [],
                    quan: [],
                    giay: [],
                    phu_kien: [],
                    style: []
                },
                paramHistories: {
                    height: '',
                    weight: '',
                    gender: '',
                    season: '',
                    style: []
                },
                leftTab: 'info',
            },
            computed: {
                allSelectedItems() {
                    return [
                        ...this.selectedItems.ao,
                        ...this.selectedItems.quan,
                        ...this.selectedItems.giay,
                        ...this.selectedItems.phu_kien,
                        ...this.selectedItems.style
                    ];
                }
            },
            methods: {
                isSelected(item, type) {
                    return this.selectedItems[type].includes(item);
                },
                toggleItem(item, type) {
                    if (this.isSelected(item, type)) {
                        this.selectedItems[type] = this.selectedItems[type].filter(i => i !== item);
                    } else {
                        this.selectedItems[type].push(item);
                    }
                },
                removeSelectedItem(item) {
                    for (const key of Object.keys(this.selectedItems)) {
                        this.selectedItems[key] = this.selectedItems[key].filter(i => i !== item);
                    }
                },
                resizeTextarea(event) {
                    const textarea = event.target;
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                },
                async sendMessage() {
                    const message = this.userMessage.trim();
                    if (!message) return;

                    // Disable send button during request
                    this.isSending = true;

                    // Add user message
                    this.messages.push({
                        type: 'user',
                        content: message
                    });

                    // Clear input
                    this.userMessage = '';

                    try {
                        // Prepare API request data
                        const requestData = {
                            message: message,
                            paramHistories: this.paramHistories,
                            countAsk: this.countAsk,
                            lastAsk: this.lastAsk,
                            selectedItems: this.selectedItems
                        };

                        // Send request to API
                        const response = await axios.post('/ai/ask', requestData);

                        this.paramHistories = response.data.paramHistories;
                        this.countAsk++;
                        this.lastAsk = response.data.content;

                        if (response.data.isEnd) {
                            // L∆∞u l·ªãch s·ª≠ ƒë√∫ng c·∫•u tr√∫c
                            this.history.push({
                                time: new Date().toLocaleString(),
                                paramHistories: { ...this.paramHistories },
                                results: Array.isArray(response.data.content) ? response.data.content : [response.data.content],
                                star: 0
                            });
                        }

                        // Add AI response
                        this.messages.push({
                            type: 'assistant',
                            content: response.data.content || 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n l√∫c n√†y.'
                        });

                        // Scroll to bottom
                        this.$nextTick(() => {
                            const chatMessages = document.querySelector('.chat-messages');
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        });

                    } catch (error) {
                        console.error('Error sending message:', error);
                        
                        // Show error message
                        this.messages.push({
                            type: 'assistant',
                            content: 'Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i sau.'
                        });
                    } finally {
                        // Re-enable send button
                        this.isSending = false;
                    }
                },
                async fetchData(type) {
                    try {
                        const res = await axios.get(`/api/${type}`);
                        return res.data;
                    } catch (error) {
                        console.error("Error fetching data:", error);
                        return [];
                    }
                },
                async loadData() {
                    // Load th·ªùi trang data
                    const [ao, quan, giay, phu_kien] = await Promise.all([
                        this.fetchData('ao'),
                        this.fetchData('quan'),
                        this.fetchData('giay'),
                        this.fetchData('phu_kien')
                    ]);
                    this.aoList = ao.map(i => i.name_b);
                    this.quanList = quan.map(i => i.name_b);
                    this.giayList = giay.map(i => i.name_b);
                    this.phuKienList = phu_kien.map(i => i.name_b);
                },
                openHistoryPopup(item) {
                    this.selectedHistoryItem = item;
                    this.showPopup = true;
                },
                closePopup() {
                    this.showPopup = false;
                    this.selectedHistoryItem = null;
                },
                getNameById(type, id) {
                    let list = [];
                    if (type === 'ao') list = this.aoListRaw || [];
                    if (type === 'quan') list = this.quanListRaw || [];
                    if (type === 'giay') list = this.giayListRaw || [];
                    if (type === 'phu_kien') list = this.phuKienListRaw || [];
                    const found = list.find(i => i.id === id);
                    return found ? found.name_b : `#${id}`;
                },
                getNamesByIds(list, arr) {
                    if (!Array.isArray(arr) || !Array.isArray(list)) return '';
                    return arr.map(obj => {
                        // N·∫øu l√† object c√≥ id
                        if (typeof obj === 'object' && obj.id !== undefined) {
                            const found = list.find(i => i.id === obj.id);
                            return found ? found.name_b : '';
                        }
                        // N·∫øu l√† id s·ªë
                        if (typeof obj === 'number') {
                            const found = list.find(i => i.id === obj);
                            return found ? found.name_b : '';
                        }
                        return '';
                    }).filter(Boolean).join(', ');
                },
            },
            mounted() {
                this.loadData();
                
                // Initialize chat input height
                this.$nextTick(() => {
                    const chatInput = document.querySelector('.chat-input');
                    if (chatInput) {
                        chatInput.style.height = 'auto';
                        chatInput.style.height = chatInput.scrollHeight + 'px';
                    }
                });
                // L∆∞u raw data ƒë·ªÉ tra c·ª©u t√™n theo id
                this.fetchData('ao').then(data => this.aoListRaw = data);
this.fetchData('quan').then(data => this.quanListRaw = data);
this.fetchData('giay').then(data => this.giayListRaw = data);
this.fetchData('phu_kien').then(data => this.phuKienListRaw = data);
            }
        });
    </script>
</body>
</html>